

configfile: "workflow/config/config.yaml"


ds_features = config['downsample_features']
metadata = config['metadata']
species_signal = config['species_signal']
accessions = config['accessions']

fedsim_conf_svd_cent = config['fedsim_conf_svd'][0]
fedsim_conf_svd_fed = config['fedsim_conf_svd'][1]
fedsim_conf_randfor_cent = config['fedsim_conf_randfor'][0]
fedsim_conf_randfor_fed = config['fedsim_conf_randfor'][1]


def load_fedsim_config(toml_path):
    import rtoml
    with open(toml_path, "r") as f:
        config = rtoml.load(f)
    # get fc users
    fc_users = []
    for cl in config['clients'].values():
        fc_users.append(cl['fc_username'])
    # project id
    pid = config['general']['project_id']
    return pid, fc_users


# load project ids and fc users
pid_svd_fed, fc_users_fed = load_fedsim_config(fedsim_conf_svd_fed)
pid_svd_cent, fc_users_cent = load_fedsim_config(fedsim_conf_svd_cent)
pid_randfor_fed, fc_users_fed = load_fedsim_config(fedsim_conf_randfor_fed)
pid_randfor_cent, fc_users_cent = load_fedsim_config(fedsim_conf_randfor_cent)




rule all:
    input:
        # f"data/public_cohorts/species.csv",
        ############# SVD ###############
        # expand("results/fedsim_fed/{u}/{pid}/pca/localData.csv", u=fc_users_fed, pid=pid_svd_fed),
        # expand("results/fedsim_cent/{u}/{pid}/pca/localData.csv", u=fc_users_cent, pid=pid_svd_cent),
        # "results/fedsim_fed/combined_localdata.csv",
        ############# Random Forest ###############
        expand("results/fedsim_fed/{u}/{pid}/pred.csv", u=fc_users_fed, pid=pid_randfor_fed),
        expand("results/fedsim_cent/{u}/{pid}/pred.csv", u=fc_users_cent, pid=pid_randfor_cent),
        "results/fedsim_fed/combined_randfor.csv",
        



rule prep_data:
    output:
        expand("data/public_cohorts/{acc}/species_header_index_nostatus.csv", acc=accessions),   # SVD
        expand("data/public_cohorts/{acc}/species.csv", acc=accessions),                         # randfor    
        "data/public_cohorts/species_header_index_nostatus.csv",                                 # SVD 
        "data/public_cohorts/species.csv",                                                       # randfor      
    params:
        ds_features=ds_features,
    shell:
        f"python workflow/scripts/prep_public_cohorts.py "
        f" --outdir data/public_cohorts/ --downsample-features {params.ds_features}"


rule fedsim_svd_fed:
    input:
        data=expand("data/public_cohorts/{acc}/species_header_index_nostatus.csv", acc=accessions),
    output:
        expand("results/fedsim_fed/{u}/data/workflows/Project_{pid}/Run_1/results_pr{pid}_run1_step1.zip", u=fc_users_fed, pid=pid_svd_fed),
    params:
        conf=fedsim_conf_svd_fed,
    resources:
        serial=1,
    shell:
        f"fedsim -c {params.conf} -v "



rule fedsim_svd_cent:
    input:
        data="data/public_cohorts/species_header_index_nostatus.csv",
    output:
        expand("results/fedsim_cent/{u}/data/workflows/Project_{pid}/Run_1/results_pr{pid}_run1_step1.zip", u=fc_users_cent, pid=pid_svd_cent),
    params:
        conf=fedsim_conf_svd_cent,
    resources:
        serial=1,
    shell:
        f"fedsim -c {params.conf} -v "



rule fedsim_randfor_fed:
    input:
        data=expand("data/public_cohorts/{acc}/species.csv", acc=accessions),
    output:
        expand("results/fedsim_fed/{u}/data/workflows/Project_{pid}/Run_1/results_pr{pid}_run1_step1.zip", u=fc_users_fed, pid=pid_randfor_fed),
    params:
        conf=fedsim_conf_randfor_fed,
    resources:
        serial=1,
    shell:
        f"fedsim -c {params.conf} -v "



rule fedsim_randfor_cent:
    input:
        data="data/public_cohorts/species.csv",
    output:
        expand("results/fedsim_cent/{u}/data/workflows/Project_{pid}/Run_1/results_pr{pid}_run1_step1.zip", u=fc_users_cent, pid=pid_randfor_cent),
    params:
        conf=fedsim_conf_randfor_cent,
    resources:
        serial=1,
    shell:
        f"fedsim -c {params.conf} -v "



rule unzip_fedsim:
    input:
        "results/fedsim_{mode}/{u}/data/workflows/Project_{pid}/Run_1/results_pr{pid}_run1_step1.zip"
    output:
        "results/fedsim_{mode}/{u}/{pid}/some/output.csv",
    shell:
        "unzip -o {input} -d results/fedsim_{wildcards.mode}/{wildcards.u}/{wildcards.pid} "



use rule unzip_fedsim as unzip_fedsim_svd with:
    output:
        "results/fedsim_{mode}/{u}/{pid}/pca/localData.csv",


use rule unzip_fedsim as unzip_fedsim_randfor with:
    output:
        "results/fedsim_{mode}/{u}/{pid}/pred.csv",
        "results/fedsim_{mode}/{u}/{pid}/proba.csv",
        "results/fedsim_{mode}/{u}/{pid}/test.csv",




rule combine_federated_results:
    input:
        expand("results/fedsim_fed/{u}/{pid}/pca/localData.csv", u=fc_users_fed, pid=pid_svd_fed),
    output:
        "results/fedsim_fed/combined_localdata.csv",
    params: accessions=accessions,
    shell:
        "python workflow/scripts/combine_federated_results.py "
        " --input {input} "
        " --output {output} "
        " --accessions {params.accessions} "



rule combine_federated_randfor:
    input:
        pred=expand("results/fedsim_fed/{u}/{pid}/pred.csv", u=fc_users_fed, pid=pid_randfor_fed),
        prob=expand("results/fedsim_fed/{u}/{pid}/proba.csv", u=fc_users_fed, pid=pid_randfor_fed),
        true=expand("results/fedsim_fed/{u}/{pid}/test.csv", u=fc_users_fed, pid=pid_randfor_fed),
    output:
        "results/fedsim_fed/combined_randfor.csv",
    params: accessions=accessions,
    shell:
        "python workflow/scripts/combine_federated_randfor.py "
        " --input_pred {input.pred} "
        " --input_prob {input.prob} "
        " --input_true {input.true} "
        " --output {output} "
        " --accessions {params.accessions} "



# rule viz_svd:  run manually

    